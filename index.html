<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>LFJC Online Exam</title>
<style>
/* ----------------- KEEP YOUR ORIGINAL STYLES INTACT ----------------- */
body{font-family:"SF Pro Display",Arial,sans-serif;margin:0;background:#fff;color:#000;}
header{background:linear-gradient(145deg,#E6E6FA,#D8BFD8);color:#4B0082;text-align:center;padding:20px;font-size:36px;font-weight:700;letter-spacing:1.5px;box-shadow:0 5px #aaa;text-shadow:0 1px 2px #fff;}

/* Mode selection */
#modeSelection{display:flex;justify-content:center;align-items:center;height:85vh;gap:60px;}
button{position:relative;overflow:hidden;cursor:pointer;border:none;border-radius:12px;transition:all .18s ease;box-shadow:0 6px #aaa;background:linear-gradient(to bottom,#fafaff,#dcd6f7);color:#4B0082;font-weight:600;}
button::before{content:"";position:absolute;top:0;left:-80%;width:50%;height:100%;background:linear-gradient(120deg,rgba(255,255,255,0.35),rgba(255,255,255,0.05));transform:skewX(-25deg);transition:left .5s ease;}
button:hover::before{left:130%}
button:hover{transform:translateY(-2px);box-shadow:0 8px 15px rgba(0,0,0,.28);}
button:active{transform:translateY(3px) scale(.98);box-shadow:0 3px 6px rgba(0,0,0,.35) inset;}
.modeBtn{padding:20px 50px;font-size:28px;border-radius:18px}
#adminSaveBtn,#logoutAdminBtn,#stuLoadSavedBtn,#stuStartBtn,#backBtn{transform:scale(1.2);padding:15px 40px;font-size:20px;margin-right:15px;}

/* Panels */
#adminPanel,#studentPanel{display:none;padding:20px;text-align:center}

/* Input error blink */
input.error{animation: glowRed 0.5s alternate infinite; border-color:red;}
@keyframes glowRed{0%{box-shadow:0 0 5px red;}100%{box-shadow:0 0 15px red;}}

/* Glow start button */
.glow{animation:glowStart 1s infinite alternate;}
@keyframes glowStart{0%{box-shadow:0 0 5px #32CD32;}100%{box-shadow:0 0 25px #32CD32;}}

/* Timer */
#timerEl{font-size:28px;font-weight:bold;color:#4B0082;padding:10px 18px;border-radius:8px;background:#f0f0ff;display:inline-block;transition:all .3s ease;}
@keyframes blinkTimerYellow{0%{background:#ffeb3b;color:#000;}50%{background:#f0f0ff;color:#4B0082;}100%{background:#ffeb3b;color:#000;}}
@keyframes blinkTimerRed{0%{background:#ff6666;color:#fff;}50%{background:#fff;color:#4B0082;}100%{background:#ff6666;color:#fff;}}

/* Form group */
.form-group{display:flex;flex-direction:row;align-items:center;justify-content:center;margin-bottom:15px;}
.form-group label{font-size:1.15rem;font-weight:600;margin-right:10px;color:#4B0082;width:180px;text-align:right;}
input[type="text"],input[type="number"],select,textarea{padding:10px 12px;font-size:1.1rem;border-radius:10px;border:1.5px solid #4B0082;outline:none;min-width:300px;transition:all .2s ease-in-out;}
input:focus,select:focus,textarea:focus{border-color:#836fff;box-shadow:0 0 8px rgba(131,111,255,.4);}

/* Admin content spacing */
#adminContent .form-group{margin-bottom:12px;}
#adminContent button{margin-top:10px;margin-right:10px;}

/* Options */
.optBtn{font-size:18px;padding:10px 25px;margin:8px;border:2px solid #4B0082;background:#fff;border-radius:8px;box-shadow:0 5px #aaa;transition:all .18s ease;}
.optBtn:hover{transform:translateY(-2px);box-shadow:0 3px #777;background:#f0e8ff}
.optBtn:active{transform:translateY(3px);box-shadow:0 2px #555}
.optBtn.selected{background:#32CD32;color:#fff;border-color:#2fa92f}

/* Exam header */
#examHeader{display:flex;justify-content:space-between;align-items:center;background:linear-gradient(145deg,#E6E6FA,#D8BFD8);color:#000;padding:12px 20px;font-size:24px;font-weight:bold;border-radius:8px;margin-bottom:10px;flex-wrap:wrap;box-shadow:0 4px #aaa;}

/* Navigation & palette */
.navContainer{display:flex;justify-content:center;gap:15px;margin:10px 0;flex-wrap:wrap}
.navBtn{font-size:18px;padding:12px 30px;border-radius:9px;color:#fff;font-weight:bold;cursor:pointer;background:linear-gradient(145deg,#1E90FF,#4682B4);}
#markReviewBtn{background:linear-gradient(145deg,#ffb84d,#ff9900)}
#submitBtn{background:linear-gradient(145deg,#c8b88a,#b49e60)}
#paletteContainer button{width:42px;height:42px;border-radius:50%;font-size:16px;margin:3px;border:1px solid #4B0082;background:#E6E6FA;color:#4B0082;box-shadow:0 5px #999;}
#paletteContainer button.selected{background:#32CD32;color:#fff;border-color:#2fa92f}
#paletteContainer button.reviewed{background:yellow;color:#000}
#paletteContainer button.current{border:3px solid red}

/* Footer */
footer{background:#E6E6FA;color:#4B0082;padding:15px;text-align:center;font-weight:bold;position:fixed;width:100%;bottom:0;}

/* Section title style */
.sectionTitle{font-size:28px;color:#4B0082;font-weight:bold;margin-bottom:10px;}
</style>
</head>
<body>
<header>LFJC ONLINE EXAMINATION</header>

<!-- MODE SELECTION -->
<div id="modeSelection">
  <button class="modeBtn" id="teacherModeBtn">ADMIN</button>
  <button class="modeBtn" id="studentModeBtn">STUDENT</button>
</div>

<!-- ----------------- ADMIN PANEL ----------------- -->
<div id="adminPanel">
  <h2>Welcome Admin</h2>
  <div class="form-group"><label>Password</label><input type="password" id="adminPass" placeholder="Enter password"></div>
  <button id="adminLoginBtn">Login</button>

  <div id="adminContent" style="display:none;text-align:center;margin-top:20px;">
    <div class="form-group"><label>Exam Name</label><input type="text" id="examName"></div>
    <div class="form-group"><label>Date (d/m/y)</label><input type="text" id="examDate" placeholder="e.g. 8/11/2025"></div>
    <div class="form-group"><label>Duration (minutes)</label><input type="number" id="examDuration"></div>
    <div class="form-group"><label>Marks per Question</label><input type="number" id="examMarks"></div>
    <div class="form-group"><label>Negative Marks</label>
      <select id="examNegative">
        <option value="0">0</option>
        <option value="-1">-1</option>
        <option value="-2">-2</option>
        <option value="-3">-3</option>
        <option value="-4">-4</option>
        <option value="-5">-5</option>
      </select>
    </div>

    <!-- ----------------- DRIVE LINKS FOR SECTIONS ----------------- -->
    <div class="form-group" style="flex-direction:column;align-items:flex-start;">
      <label>Google Drive Links for Sections:</label>
      <input type="text" id="driveMaths" placeholder="Mathematics Drive Folder URL" style="margin-bottom:6px;">
      <input type="text" id="driveMathsA" placeholder="Maths-A Drive Folder URL" style="margin-bottom:6px;">
      <input type="text" id="driveMathsB" placeholder="Maths-B Drive Folder URL" style="margin-bottom:6px;">
      <input type="text" id="drivePhysics" placeholder="Physics Drive Folder URL" style="margin-bottom:6px;">
      <input type="text" id="driveChemistry" placeholder="Chemistry Drive Folder URL">
    </div>

    <h3>Answer Key (A/B/C/D only)</h3>
    <textarea id="answerKey" rows="5" style="width:95%;"></textarea>

    <div class="form-group"><label>Optional Webhook URL</label><input type="text" id="webhookURL" placeholder="https://script.google.com/..."></div>

    <div class="form-group" style="margin-top:15px;">
      <button id="adminSaveBtn">Save Exam</button>
      <button id="logoutAdminBtn">Logout</button>
    </div>
  </div>
</div>

<!-- ----------------- STUDENT PANEL ----------------- -->
<div id="studentPanel">
  <div id="studentEntry">
    <div class="form-group"><label>Name</label><input type="text" id="stuName" placeholder="Only letters & spaces"></div>
    <div class="form-group"><label>Section</label><input type="text" id="stuSection" placeholder="Letters & digits"></div>
    <div class="form-group"><label>Roll</label><input type="text" id="stuRoll" placeholder="Digits only"></div>
    <div class="form-group"><label>Admission No</label><input type="text" id="stuAdm" placeholder="Digits only"></div>
    <div class="form-group">
      <button id="stuLoadSavedBtn" style="display:none;">Load Exam</button>
      <button id="stuStartBtn" style="display:none;">Start Exam</button>
      <button id="backBtn">Back</button>
    </div>
    <p id="studentMsg"></p>
  </div>

  <div id="examArea" style="display:none">
    <div id="examHeader">
      <div id="stuInfo" style="text-align:left;"></div>
      <div id="stuQInfo" style="text-align:center;"></div>
      <div id="timerEl">ðŸ•’ 00:00</div>
    </div>

    <div id="questionContainer" style="text-align:center;margin-top:10px;"></div>

    <div class="navContainer">
      <button class="navBtn" id="prevBtn">â¬… Previous</button>
      <button class="navBtn" id="markReviewBtn">Review</button>
      <button class="navBtn" id="nextBtn">Next âž¡</button>
      <button class="navBtn" id="submitBtn">Submit Exam</button>
    </div>

    <div id="paletteContainer"></div>
  </div>
</div>

<footer>LFJC@2025 All rights reserved</footer>

<script>
// ----------------- MODE SELECT -----------------
document.getElementById('studentModeBtn').onclick=()=>{
  document.getElementById('modeSelection').style.display='none';
  document.getElementById('studentPanel').style.display='block';
};
document.getElementById('teacherModeBtn').onclick=()=>{
  document.getElementById('modeSelection').style.display='none';
  document.getElementById('adminPanel').style.display='block';
};

// ----------------- ADMIN LOGIN -----------------
document.getElementById('adminLoginBtn').onclick=()=>{
  if(document.getElementById('adminPass').value==='lfjc2025'){
    document.getElementById('adminContent').style.display='block';
    alert("Admin logged in");
  } else alert("Incorrect password");
};

// ----------------- FORMAT ANSWER KEY -----------------
document.getElementById('answerKey').addEventListener('input', e=>{
  let val=e.target.value.toUpperCase().replace(/[^ABCD]/g,'');
  let formatted='';
  for(let i=0;i<val.length;i++){
    formatted+=val[i];
    if((i+1)%5===0) formatted+=' ';
    if((i+1)%30===0) formatted+='\n';
  }
  e.target.value=formatted.trim();
});

// ----------------- FETCH IMAGES FROM DRIVE -----------------
async function fetchSectionImages(folderLink){
  if(!folderLink) return [];
  try {
    const idMatch = folderLink.match(/[-\w]{25,}/);
    if(!idMatch) return [];
    const folderId = idMatch[0];
    const response = await fetch(`YOUR_APPS_SCRIPT_URL?folderId=${folderId}`);
    const files = await response.json();
    files.sort((a,b)=>a.name.localeCompare(b.name));
    return files.map(f=>({name:f.name,data:f.url}));
  } catch(err){ console.error(err); return []; }
}

// ----------------- SAVE EXAM -----------------
document.getElementById('adminSaveBtn').onclick = async () => {
  const sections = [
    {name:'Mathematics', link:document.getElementById('driveMaths').value},
    {name:'Maths-A', link:document.getElementById('driveMathsA').value},
    {name:'Maths-B', link:document.getElementById('driveMathsB').value},
    {name:'Physics', link:document.getElementById('drivePhysics').value},
    {name:'Chemistry', link:document.getElementById('driveChemistry').value},
  ];

  const fileList = [];
  for(let sec of sections){
    if(!sec.link.trim()) continue; // skip empty drive links
    const imgs = await fetchSectionImages(sec.link);
    imgs.forEach(img=>img.section=sec.name);
    fileList.push(...imgs);
  }

  if(fileList.length===0){ alert("No images found in Drive folders!"); return; }

  const keyLength = document.getElementById('answerKey').value.replace(/\s+/g,'').length;
  if(keyLength!==fileList.length){ alert("Answer key and total questions do not match!"); return; }

  const exam = {
    name: document.getElementById('examName').value,
    date: document.getElementById('examDate').value,
    durationMin: parseInt(document.getElementById('examDuration').value),
    marksPerQuestion: parseFloat(document.getElementById('examMarks').value),
    negativeMark: parseFloat(document.getElementById('examNegative').value),
    files: fileList,
    key: document.getElementById('answerKey').value.replace(/\s+/g,'').split(''),
    webhook: document.getElementById('webhookURL').value || '',
  };
  localStorage.setItem("LFJC_EXAM", JSON.stringify(exam));
  alert("Exam saved successfully with sections!");
};

// ----------------- LOGOUT -----------------
document.getElementById('logoutAdminBtn').onclick=()=>location.reload();

// ----------------- STUDENT INPUT VALIDATION -----------------
function validateStudentInputs(){
  const name=document.getElementById('stuName');
  const sec=document.getElementById('stuSection');
  const roll=document.getElementById('stuRoll');
  const adm=document.getElementById('stuAdm');
  let validName=/^[A-Za-z ]+$/.test(name.value);
  let validSec=/^[A-Za-z0-9]+$/.test(sec.value);
  let validRoll=/^[0-9]+$/.test(roll.value);
  let validAdm=/^[0-9]+$/.test(adm.value);
  name.classList.toggle('error',!validName && name.value!=="");
  sec.classList.toggle('error',!validSec && sec.value!=="");
  roll.classList.toggle('error',!validRoll && roll.value!=="");
  adm.classList.toggle('error',!validAdm && adm.value!=="");
  const allValid=validName && validSec && validRoll && validAdm;
  document.getElementById('stuLoadSavedBtn').style.display=allValid?'inline-block':'none';
  return allValid;
}
['stuName','stuSection','stuRoll','stuAdm'].forEach(id=>{
  document.getElementById(id).addEventListener('input',validateStudentInputs);
});

// ----------------- LOAD & START EXAM -----------------
let examData=null,progress=null,timerInterval=null,examLoaded=false;
document.getElementById('stuLoadSavedBtn').onclick=()=>{
  if(!validateStudentInputs())return;
  const raw=localStorage.getItem("LFJC_EXAM");
  if(!raw)return alert("No exam found");
  examData=JSON.parse(raw);
  examLoaded=true;
  const startBtn=document.getElementById('stuStartBtn');
  startBtn.style.display='inline-block';
  startBtn.disabled=false;
  startBtn.classList.add('glow');
  document.getElementById('studentMsg').textContent=`Loaded: ${examData.name} (${examData.files.length} Q)`;
};
document.getElementById('backBtn').onclick=()=>location.reload();
document.getElementById('stuStartBtn').onclick=()=>{
  if(!examLoaded)return;
  const name=document.getElementById('stuName').value.trim();
  const sec=document.getElementById('stuSection').value.trim();
  const roll=document.getElementById('stuRoll').value.trim();
  const adm=document.getElementById('stuAdm').value.trim();
  progress={
    answers:Array(examData.files.length).fill(null),
    review:Array(examData.files.length).fill(false),
    currentIndex:0,
    student:{name,sec,roll,adm,date:new Date().toLocaleDateString()},
    timeLeftSec:examData.durationMin*60
  };
  document.getElementById('studentEntry').style.display='none';
  document.getElementById('examArea').style.display='block';
  renderQuestion();
  renderPalette();
  startTimer();
};

// ----------------- TIMER -----------------
function startTimer(){
  const timerEl=document.getElementById('timerEl');
  const stuInfo=document.getElementById('stuInfo');
  const stuQInfo=document.getElementById('stuQInfo');

  timerInterval=setInterval(()=>{
    if(progress.timeLeftSec<=0){clearInterval(timerInterval);alert("Time up!");submitExam();return;}
    progress.timeLeftSec--;
    const min=Math.floor(progress.timeLeftSec/60);
    const sec=progress.timeLeftSec%60;
    timerEl.textContent=`ðŸ•’ ${min.toString().padStart(2,'0')}:${sec.toString().padStart(2,'0')}`;

    // Blinking effect
    timerEl.style.animation='';
    if(progress.timeLeftSec<=60) timerEl.style.animation='blinkTimerRed 1s infinite';
    else if(progress.timeLeftSec<=300) timerEl.style.animation='blinkTimerYellow 1s infinite';

    stuInfo.textContent=`${progress.student.name} | Sec: ${progress.student.sec} | Roll: ${progress.student.roll} | Adm: ${progress.student.adm}`;
    stuQInfo.textContent=`Q ${progress.currentIndex+1}/${examData.files.length}`;
  },1000);
}

// ----------------- RENDER QUESTION -----------------
function renderQuestion(){
  const q=document.getElementById('questionContainer');
  const file=examData.files[progress.currentIndex];
  const imgTag=`<img src="${file.data}" alt="Q${progress.currentIndex+1}" style="max-width:95%;border-radius:10px;"><br>`;
  q.innerHTML=imgTag;
  ["A","B","C","D"].forEach(opt=>{
    const btn=document.createElement('button');
    btn.className='optBtn';
    btn.textContent=opt;
    if(progress.answers[progress.currentIndex]===opt)btn.classList.add('selected');
    btn.onclick=()=>{
      progress.answers[progress.currentIndex]=opt;
      document.querySelectorAll('.optBtn').forEach(b=>b.classList.remove('selected'));
      btn.classList.add('selected');
      renderPalette();
    };
    q.appendChild(btn);
  });
}

// ----------------- NAVIGATION -----------------
document.getElementById('nextBtn').onclick=()=>{
  if(progress.currentIndex<examData.files.length-1){progress.currentIndex++;renderQuestion();renderPalette();}
};
document.getElementById('prevBtn').onclick=()=>{
  if(progress.currentIndex>0){progress.currentIndex--;renderQuestion();renderPalette();}
};
document.getElementById('markReviewBtn').onclick=()=>{
  progress.review[progress.currentIndex]=!progress.review[progress.currentIndex];
  renderPalette();
};

// ----------------- PALETTE -----------------
function renderPalette(){
  const cont=document.getElementById('paletteContainer');
  cont.innerHTML='';
  progress.answers.forEach((ans,i)=>{
    const b=document.createElement('button');
    b.textContent=i+1;
    if(i===progress.currentIndex)b.classList.add('current');
    if(progress.review[i])b.classList.add('reviewed');
    if(ans)b.classList.add('selected');
    b.onclick=()=>{progress.currentIndex=i;renderQuestion();renderPalette();};
    cont.appendChild(b);
  });
}

// ----------------- SUBMIT EXAM -----------------
document.getElementById('submitBtn').onclick=()=>submitExam();
function submitExam(){
  clearInterval(timerInterval);
  let correct=0,wrong=0,blank=0;
  for(let i=0;i<examData.files.length;i++){
    const given=progress.answers[i];
    const key=examData.key[i];
    if(!given)blank++;
    else if(given===key)correct++;
    else wrong++;
  }
  const total=examData.files.length;
  const marks=(correct*examData.marksPerQuestion + wrong*examData.negativeMark).toFixed(2);
  alert(`Exam submitted!\nCorrect: ${correct}\nWrong: ${wrong}\nBlank: ${blank}\nTotal: ${total}\nMarks: ${marks}`);
  location.reload();
}
</script>
</body>
</html>
